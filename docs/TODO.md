# 《星宠挂机》开发待办事项清单

## 📋 项目概览

- **项目名称**：星宠挂机小游戏
- **开发周期**：22-26周（约5-6个月）
- **开发模式**：敏捷开发，分阶段上线

### 图标说明

- 🎨 **前端任务** - React + TypeScript
- 🔧 **后端任务** - Node.js + Express
- 🔄 **前后端联调** - 需要前后端配合
- 📊 **数据库/架构** - Prisma + PostgreSQL
- 🧪 **测试任务** - 单元测试/集成测试
- 📝 **文档任务** - 文档编写

---

## 🎯 第一阶段：MVP 核心闭环 (8-10周)

### 1. 用户系统模块

#### 1.1 认证与登录

**后端任务：**
- [x] 📊 设计用户数据库模型（User表：userId, phone, deviceId, kycStatus等）✅ 2025-10-10 已完成
- [x] 🔧 实现手机号验证码登录接口 `POST /api/auth/login` ✅ 2025-10-10 15:30
  - [x] 验证手机号格式
  - [x] 验证验证码有效性
  - [x] 生成JWT token
  - [x] 记录登录日志
- [x] 🔧 实现验证码发送接口 `POST /api/auth/send-code` ✅ 2025-10-10 15:30
  - [x] 对接短信服务商API（模拟实现，生产需对接真实服务）
  - [x] 验证码存储（内存Map，生产需改为Redis，5分钟有效）
  - [ ] 防刷限制（同号码1分钟1次）⏳ 待Redis实现
- [x] 🔧 实现JWT token生成与验证机制 ✅ 2025-10-10 15:30
  - [x] token签名与加密
  - [x] token过期时间设置（7天）
  - [x] refresh token机制
- [ ] 🔧 添加设备指纹绑定逻辑 ⏳ 部分实现
  - [x] 设备ID校验
  - [ ] 单设备登录账号数限制（≤2个）⏳ 待Redis实现

**前端任务：**
- [x] 🎨 创建登录页面 `idle-game-frontend/src/pages/auth/LoginPage.tsx` ✅ 2025-10-10 16:00
  - [x] 手机号输入框（带格式验证）
  - [x] 验证码输入框
  - [x] 发送验证码按钮（带倒计时）
  - [x] 登录按钮
  - [x] 错误提示组件
- [x] 🎨 实现验证码倒计时功能 ✅ 2025-10-10 16:00
  - [x] 60秒倒计时UI
  - [x] 防止重复点击
- [x] 🎨 添加登录态持久化 ✅ 2025-10-10 16:00
  - [x] token存储到localStorage
  - [x] 自动token刷新逻辑（API拦截器实现）
  - [x] 登录过期跳转处理（路由守卫）

**联调任务：**
- [x] 🔄 联调登录流程（前端调用后端登录接口）✅ 2025-10-10 16:00
- [x] 🔄 测试token刷新机制 ✅ 2025-10-10 16:00（API拦截器）
- [ ] 🧪 编写登录流程E2E测试 ⏳ 待实现

#### 1.2 实名认证

**后端任务：**
- [x] 📊 设计实名认证数据模型 ✅ 2025-10-10 已完成
  - [x] realName字段
  - [x] idCard字段（加密存储，使用AES-256-CBC）
  - [x] kycStatus枚举（PENDING/VERIFIED/REJECTED）
- [x] 🔧 对接第三方实名认证服务接口 `POST /api/kyc/verify` ✅ 2025-10-10 16:30
  - [x] 调用认证服务API（模拟实现，生产需对接真实服务）
  - [x] 结果存储与状态更新
  - [x] 认证失败重试机制
- [x] 🔧 实现认证状态校验中间件 ✅ 2025-10-10 16:30
  - [x] 需要实名的接口添加中间件 `requireKYC`
  - [x] 未认证返回403状态码及needKYC标志
- [x] 🔧 实现新手星宠发放接口 `POST /api/pet/grant-newbie` ✅ 2025-10-10 16:30
  - [x] 认证成功后自动触发（在KYC验证接口中）
  - [x] 防止重复领取（检查用户是否已有星宠）
  - [x] 发放一只普通星宠（随机名称）

**前端任务：**
- [x] 🎨 创建实名认证页面 `idle-game-frontend/src/pages/auth/KYCPage.tsx` ✅ 2025-10-10 17:00
  - [x] 姓名输入框
  - [x] 身份证号输入框（自动大写转换）
  - [x] 提交按钮
  - [x] 隐私政策提示
- [x] 🎨 实现认证状态提示 ✅ 2025-10-10 17:00
  - [x] 认证中Loading状态
  - [x] 认证成功提示
  - [x] 认证失败提示与重试
- [x] 🎨 实现新手引导流程 ✅ 2025-10-10 17:00
  - [x] 认证完成后展示获得的星宠（动画效果）
  - [x] 引导用户进入游戏主页
  - [x] 新手提示（挂机、收益、兑换说明）

**联调任务：**
- [x] 🔄 联调实名认证流程 ✅ 2025-10-10 17:00
- [x] 🔄 API拦截器处理403错误自动跳转KYC页面 ✅ 2025-10-10 17:00
- [ ] 🧪 测试认证状态拦截 ⏳ 待测试环境验证

#### 1.3 用户中心

**后端任务：**
- [x] 🔧 实现用户信息查询接口 `GET /api/user/profile` ✅ 2025-10-10 17:30
  - [x] 返回用户基本信息（手机号脱敏）
  - [x] 返回资产信息（宝石、贝壳、能量）
  - [x] 返回认证状态（KYC状态）
  - [x] 返回星宠数量和列表（前5只）
- [x] 🔧 实现用户资产余额查询接口 `GET /api/wallet/balance` ✅ 2025-10-10 17:30
  - [x] 查询宝石余额
  - [x] 查询贝壳余额
  - [x] 查询能量值（含上限和最后更新时间）
- [x] 🔧 实现用户信息编辑接口 `PUT /api/user/profile` ✅ 2025-10-10 17:30
  - [x] 昵称修改（功能开发中）
  - [x] 头像上传（功能开发中）
- [x] 🔧 实现用户统计接口 `GET /api/user/stats` ✅ 2025-10-10 17:30
  - [x] 星宠数量统计
  - [x] 总产出统计
  - [x] 交易次数统计
- [x] 🔧 实现交易流水查询接口 `GET /api/wallet/transactions` ✅ 2025-10-10 17:30
  - [x] 支持分页查询
  - [x] 支持按货币类型筛选
  - [x] 支持按交易类型筛选

**前端任务：**
- [x] 🎨 优化用户信息展示组件 `idle-game-frontend/src/pages/profile/components/UserProfileCard.tsx` ✅ 2025-10-10 18:00
  - [x] 显示用户头像（星星emoji）
  - [x] 显示用户昵称（脱敏显示）
  - [x] 显示认证状态（已认证/未认证徽章）
  - [x] 显示资产余额（宝石/贝壳/能量）
  - [x] 显示星宠数量
  - [x] 添加编辑按钮
  - [x] Loading状态展示
- [x] 🎨 创建信息编辑弹窗 `idle-game-frontend/src/pages/profile/components/EditProfileModal.tsx` ✅ 2025-10-10 18:00
  - [x] 昵称编辑（带字符限制20）
  - [x] 头像选择（emoji选择器）
  - [x] 表单验证
  - [x] 保存功能
  - [x] 功能说明提示

**联调任务：**
- [x] 🔄 联调用户信息展示 ✅ 2025-10-10 18:00
- [x] 🔄 联调信息编辑功能 ✅ 2025-10-10 18:00
- [x] 🔄 API集成完成 ✅ 2025-10-10 18:00

### 2. 星宠基础模块

#### 2.1 数据模型设计

**数据库任务：**
- [ ] 📊 设计星宠数据库模型（Pet表）
  - [ ] petId (主键)
  - [ ] userId (外键关联用户)
  - [ ] rarity (稀有度)
  - [ ] level (等级，默认1)
  - [ ] exp (经验值)
  - [ ] bondTag (羁绊标签)
  - [ ] createdAt/updatedAt (时间戳)
- [ ] 📊 定义星宠稀有度枚举
  - [ ] COMMON (普通)
  - [ ] RARE (稀有)
  - [ ] EPIC (史诗)
  - [ ] LEGENDARY (传说)
  - [ ] MYTHIC (神话)
- [ ] 📊 设计星宠属性配置表 (PetConfig)
  - [ ] 基础产出速率
  - [ ] 稀有度权重
  - [ ] 成长系数

#### 2.2 星宠展示 ✅

> ✅ **完成时间**: 2025-10-11 18:15
> **完成内容**: 完整的星宠展示系统，包括列表、详情、筛选、排序、统计

**后端任务：** ✅
- [x] 🔧 实现星宠列表查询接口 `GET /api/pet/list` ✅ 2025-10-11 17:45
  - [x] 查询用户所有星宠
  - [x] 支持按稀有度筛选
  - [x] 支持按稀有度/等级/经验/时间排序
  - [x] 支持升序/降序
  - [x] 分页支持（page/limit）
  - [x] 自动计算并返回产出速率
  - [x] 返回分页信息
- [x] 🔧 实现星宠详情查询接口 `GET /api/pet/:petId` ✅ 2025-10-11 17:50
  - [x] 查询单个星宠详细信息
  - [x] 产出速率计算
  - [x] 历史产出统计（累计宝石/贝壳）
  - [x] 经验进度（当前经验、下级所需、进度百分比）
  - [x] 升级所需经验计算
- [x] 🔧 实现星宠统计接口 `GET /api/pet/stats` ✅ 2025-10-11 17:50
  - [x] 星宠总数统计
  - [x] 稀有度分布（各稀有度数量）
  - [x] 平均等级计算
  - [x] 累计产出统计

**前端任务：** ✅
- [x] 🎨 创建星宠列表页面 `idle-game-frontend/src/pages/pets/PetsPage.tsx` ✅ 2025-10-11 18:05
  - [x] 网格布局展示所有星宠
  - [x] 筛选面板（6种稀有度选项）
  - [x] 排序选择器（稀有度/等级/时间）
  - [x] 升序/降序切换按钮
  - [x] 空状态提示
  - [x] 统计卡片集成
- [x] 🎨 创建星宠卡片组件 `idle-game-frontend/src/pages/pets/components/PetCard.tsx` ✅ 2025-10-11 18:08
  - [x] 星宠图标（根据稀有度）
  - [x] 稀有度颜色带（顶部2px）
  - [x] 稀有度渐变背景
  - [x] 等级显示
  - [x] 产出速率显示（宝石/贝壳）
  - [x] 羁绊标签
  - [x] Hover缩放动画
- [x] 🎨 实现星宠稀有度视觉标识 ✅ 2025-10-11 18:08
  - [x] 普通：灰色渐变
  - [x] 稀有：蓝色渐变
  - [x] 史诗：紫色渐变
  - [x] 传说：橙色渐变
  - [x] 神话：粉红色渐变
  - [x] 稀有度徽章（圆角徽章）
- [x] 🎨 创建星宠详情弹窗 `idle-game-frontend/src/pages/pets/components/PetDetailModal.tsx` ✅ 2025-10-11 18:10
  - [x] 星宠大图标展示
  - [x] 稀有度渐变头部
  - [x] 详细属性展示（名称、等级、稀有度、羁绊）
  - [x] 经验进度条（动态进度、百分比）
  - [x] 产出速率展示（宝石/贝壳）
  - [x] 累计产出统计
  - [x] 获得时间显示
- [x] 🎨 创建星宠统计卡片 `idle-game-frontend/src/pages/pets/components/PetStatsCard.tsx` ✅ 2025-10-11 18:12
  - [x] 稀有度分布（进度条可视化）
  - [x] 百分比计算
  - [x] 平均等级显示
  - [x] 累计产出显示（宝石/贝壳）
  - [x] 响应式布局
- [x] 🎨 添加星宠导航入口 ✅ 2025-10-11 18:15
  - [x] Navbar添加星宠图标
  - [x] 路由配置（/pets）
  - [x] Layout集成

**联调任务：** ✅
- [x] 🔄 联调星宠列表展示 ✅ 2025-10-11 18:12
- [x] 🔄 联调星宠详情查看 ✅ 2025-10-11 18:12
- [x] 🔄 联调筛选和排序功能 ✅ 2025-10-11 18:12
- [x] 🔄 联调统计数据展示 ✅ 2025-10-11 18:12

#### 2.3 新手星宠发放

**后端任务：**
- [ ] 🔧 实现新手星宠自动发放逻辑
  - [ ] 实名认证成功触发
  - [ ] 检查是否已领取
  - [ ] 创建一只普通稀有度星宠
  - [ ] 记录发放日志
- [ ] 🔧 添加星宠领取记录防重复校验
  - [ ] 查询用户星宠数量
  - [ ] 标记新手奖励已领取状态

**前端任务：**
- [ ] 🎨 实现新手星宠领取动画
  - [ ] 开蛋动画效果
  - [ ] 星宠出现特效
  - [ ] 引导提示文案

**测试任务：**
- [ ] 🧪 测试重复领取防护
- [ ] 🧪 测试星宠正确发放

### 3. 挂机系统（核心）

#### 3.1 能量系统

**数据库任务：**
- [x] 📊 设计能量流水表（EnergyLedger）✅ 已完成
  - [x] ledgerId (主键)
  - [x] userId (外键)
  - [x] amount (能量变化量，正负)
  - [x] source (来源：恢复/购买/助力/任务)
  - [x] timestamp (时间戳)
- [x] 📊 在Wallet表添加能量字段 ✅ 已完成
  - [x] energy (当前能量值)
  - [x] lastEnergyUpdate (上次更新时间)

**后端任务：**
- [x] 🔧 实现能量自然恢复定时任务 ✅ 2025-10-10 18:30
  - [x] 每小时恢复10点
  - [x] 上限100点
  - [x] 使用node-cron定时执行
- [x] 🔧 实现能量消耗逻辑 ✅ 2025-10-10 18:30
  - [x] 挂机每小时消耗20点
  - [x] 能量不足自动停止挂机
  - [x] 记录能量流水
- [x] 🔧 能量查询集成到钱包接口 `GET /api/wallet/balance` ✅ 2025-10-10 18:30
  - [x] 查询当前能量值
  - [x] 返回上次更新时间
  - [x] 返回能量上限
- [ ] 🔧 实现能量购买接口 `POST /api/energy/buy` ⏳ 待实现
  - [ ] 贝壳购买能量（50贝壳/10能量）
  - [ ] 每日购买上限（200点）
  - [ ] 扣除贝壳余额
  - [ ] 增加能量值
  - [ ] 记录购买流水

**前端任务：**
- [x] 🎨 创建能量条组件 `idle-game-frontend/src/components/game/EnergyBar.tsx` ✅ 2025-10-10 19:00
  - [x] 进度条显示（当前/最大）
  - [x] 能量数值显示
  - [x] 恢复速率提示（10/小时）
  - [x] 下次恢复时间倒计时
  - [x] 颜色区分（充足/警告/危险）
- [x] 🎨 实现能量不足提醒 ✅ 2025-10-10 19:00
  - [x] 能量<20时红色警告
  - [x] UI提示能量不足
- [ ] 🎨 创建能量购买弹窗 ⏳ 待实现
  - [ ] 显示购买价格
  - [ ] 显示今日剩余购买次数
  - [ ] 确认购买按钮

**联调任务：**
- [x] 🔄 联调能量显示 ✅ 2025-10-10 19:00
- [x] 🔄 测试能量恢复定时任务 ✅ 2025-10-10 19:00
- [ ] 🧪 测试能量购买功能 ⏳ 待实现

#### 3.2 挂机收益计算

**数据库任务：**
- [x] 📊 设计产出记录表（ProductionLog）✅ 已完成
  - [x] logId (主键)
  - [x] userId (外键)
  - [x] petId (外键)
  - [x] startTime (开始时间)
  - [x] endTime (结束时间)
  - [x] isOnline (在线/离线)
  - [x] gemProduced (产出宝石)
  - [x] shellProduced (产出贝壳)
  - [x] energyConsumed (消耗能量)

**后端任务：**
- [x] 🔧 实现产出速率计算引擎 `afkService.calculateRate()` ✅ 2025-10-10 18:30
  - [x] 基础公式：`r_base × (1 + level × 0.05) × rarity_multiplier`
  - [x] b_L: 等级加成（level × 0.05）
  - [ ] b_S: 技能加成（预留）⏳
  - [ ] b_A: 活动加成（预留）⏳
  - [x] D: 动态衰减系数（当前为1，预留）
- [x] 🔧 实现在线收益累计逻辑 ✅ 2025-10-10 18:30
  - [x] 实时计算累计收益
  - [x] 消耗能量（20点/小时）
  - [x] 能量不足自动限制收益
- [x] 🔧 实现离线收益计算逻辑 ✅ 2025-10-10 18:30
  - [x] 离线收益 = 在线收益 × 80%
  - [x] 离线时长上限12小时
  - [x] 用户登录时可查询离线收益
- [x] 🔧 实现服务器时间权威机制 ✅ 2025-10-10 18:30
  - [x] 所有时间计算在服务器端
  - [x] 防止客户端时间篡改
  - [x] 使用服务器时间戳
- [ ] 🔧 添加心跳机制判定在线状态 ⏳ 待实现
  - [ ] 客户端定时刷新状态
  - [ ] 在线/离线判定
  - [ ] 当前通过状态查询实现

**后端服务层：**
- [x] 🔧 创建挂机服务 `idle-game-backend/src/services/afk.service.ts` ✅ 2025-10-10 18:30
  - [x] calculateProductionRate() - 计算收益速率
  - [x] calculateRewards() - 计算收益
  - [x] startAFK() - 开启挂机
  - [x] claimRewards() - 领取收益
  - [x] getAFKStatus() - 查询状态
  - [x] calculateOfflineRewards() - 离线收益

**联调任务：**
- [x] 🔄 联调收益计算逻辑 ✅ 2025-10-10 19:00
- [x] 🔄 测试服务器时间机制 ✅ 2025-10-10 19:00
- [x] 🔄 测试离线收益计算 ✅ 2025-10-10 19:00

#### 3.3 挂机操作接口

**后端任务：**
- [x] 🔧 实现开启挂机接口 `POST /api/afk/start` ✅ 2025-10-10 18:30
  - [x] 幂等设计（已开启则返回当前状态）
  - [x] 检查能量是否充足
  - [x] 检查是否有星宠
  - [x] 创建挂机记录
- [x] 🔧 实现领取收益接口 `POST /api/afk/claim` ✅ 2025-10-10 18:30
  - [x] 计算区间收益
  - [x] 增加宝石/贝壳余额
  - [x] 更新产出记录
  - [x] 事务保证一致性
  - [x] 消耗能量记录
- [x] 🔧 实现挂机状态查询 `GET /api/afk/status` ✅ 2025-10-10 18:30
  - [x] 返回是否挂机中
  - [x] 返回当前待领取收益
  - [x] 返回剩余能量
  - [x] 返回预计停止时间
- [x] 🔧 实现离线收益查询 `GET /api/afk/offline-rewards` ✅ 2025-10-10 18:30
  - [x] 用户登录时查询
  - [x] 计算离线时长收益
- [ ] 🔧 实现自动补能开关功能 ⏳ 待实现
  - [ ] 保存用户设置
  - [ ] 能量不足时自动购买
  - [ ] 贝壳不足时停止补能

**前端任务：**
- [x] 🎨 挂机操作API集成 ✅ 2025-10-10 19:00
  - [x] 调用开启挂机接口
  - [x] 调用领取收益接口
  - [x] 每30秒刷新挂机状态

**联调任务：**
- [x] 🔄 联调挂机开启流程 ✅ 2025-10-10 19:00
- [x] 🔄 联调收益领取流程 ✅ 2025-10-10 19:00
- [x] 🔄 测试幂等性设计 ✅ 2025-10-10 19:00
- [ ] 🧪 测试并发领取 ⏳ 待压测

#### 3.4 挂机UI界面

**前端任务：**
- [x] 🎨 重构游戏主页 `idle-game-frontend/src/pages/game/GamePage.tsx` ✅ 2025-10-10 19:00
  - [x] 改为挂机系统主界面
  - [x] 移除旧的点击游戏逻辑
  - [x] 添加挂机控制面板
  - [x] 集成所有挂机组件
- [x] 🎨 创建收益展示组件 `idle-game-frontend/src/components/game/RewardsDisplay.tsx` ✅ 2025-10-10 19:00
  - [x] 实时产出速率（宝石/小时）
  - [x] 累计待领取宝石数
  - [x] 累计待领取贝壳数
  - [x] 数字滚动动画效果
  - [x] 挂机状态标识
- [x] 🎨 实现挂机控制按钮 `idle-game-frontend/src/components/game/AFKControls.tsx` ✅ 2025-10-10 19:00
  - [x] "开始挂机"按钮（能量充足时可用）
  - [x] "挂机中"状态显示
  - [x] "领取收益"按钮（有收益时高亮+动画）
  - [x] 按钮状态联动
  - [x] 能量不足警告
- [x] 🎨 实现离线收益领取弹窗 `idle-game-frontend/src/components/game/OfflineRewardsModal.tsx` ✅ 2025-10-10 19:00
  - [x] 用户登录时自动弹出
  - [x] 显示离线时长
  - [x] 显示离线收益明细
  - [x] 精美的UI设计
  - [x] 温馨提示说明
- [ ] 🎨 添加自动补能开关 ⏳ 待实现
  - [ ] Toggle开关组件
  - [ ] 显示当前状态
  - [ ] 补能规则说明

**状态管理：**
- [x] 🎨 挂机状态通过组件state管理 ✅ 2025-10-10 19:00
  - [x] 实时查询挂机状态
  - [x] 定时刷新数据
  - [x] 离线收益检查

**联调任务：**
- [x] 🔄 联调挂机UI与后端接口 ✅ 2025-10-10 19:00
- [x] 🔄 测试实时数据更新 ✅ 2025-10-10 19:00
- [x] 🔄 测试离线收益弹窗 ✅ 2025-10-10 19:00

### 4. 经济系统基础

#### 4.1 货币系统

**数据库任务：**
- [ ] 📊 设计资产钱包表（Wallet）- 已在第3节定义
  - [ ] userId (外键，唯一)
  - [ ] gemBalance (宝石余额)
  - [ ] shellBalance (贝壳余额)
  - [ ] energy (能量值)
  - [ ] createdAt/updatedAt
- [ ] 📊 设计货币流水表（Transaction）
  - [ ] transactionId (主键)
  - [ ] userId (外键)
  - [ ] type (类型：EARN/SPEND/TRANSFER/REFUND)
  - [ ] currency (货币：GEM/SHELL)
  - [ ] amount (金额)
  - [ ] source (来源：挂机/任务/兑换等)
  - [ ] target (目标：购买/提现等)
  - [ ] description (描述)
  - [ ] timestamp (时间戳)

**后端任务：**
- [ ] 🔧 实现宝石增减服务 `walletService.updateGems()`
  - [ ] 带事务保证原子性
  - [ ] 记录流水日志
  - [ ] 余额校验（不能为负）
  - [ ] 并发控制（乐观锁）
- [ ] 🔧 实现贝壳增减服务 `walletService.updateShells()`
  - [ ] 带事务保证原子性
  - [ ] 记录流水日志
  - [ ] 余额校验
- [ ] 🔧 实现余额查询接口 `GET /api/wallet/balance`
  - [ ] 返回宝石余额
  - [ ] 返回贝壳余额
  - [ ] 返回能量值
  - [ ] 支持缓存（Redis 30秒）
- [ ] 🔧 实现流水查询接口 `GET /api/wallet/transactions`
  - [ ] 支持分页
  - [ ] 支持筛选（按类型/货币）
  - [ ] 支持时间范围查询

**前端任务：**
- [ ] 🎨 优化资产显示组件
  - [ ] 宝石余额显示（带图标）
  - [ ] 贝壳余额显示（带图标）
  - [ ] 余额变动动画效果
- [ ] 🎨 创建流水记录页面 `idle-game-frontend/src/pages/wallet/TransactionsPage.tsx`
  - [ ] 流水列表（收入/支出分色）
  - [ ] 筛选功能
  - [ ] 无限滚动加载

**联调任务：**
- [ ] 🔄 联调余额显示与更新
- [ ] 🧪 测试并发交易一致性
- [ ] 🧪 测试事务回滚

#### 4.2 汇率与兑换

**后端配置：**
- [ ] 🔧 配置货币汇率常量 `idle-game-backend/src/config/currency.ts`
  - [ ] GEM_TO_SHELL_RATE = 250 (1宝石=250贝壳)
  - [ ] GEM_TO_RMB_RATE = 1.9 (1宝石=1.9元)
  - [ ] ENERGY_PRICE_IN_SHELLS = 50 (10能量=50贝壳)
- [ ] 🔧 实现货币兑换服务 `walletService.exchange()`
  - [ ] 宝石换贝壳
  - [ ] 贝壳换能量
  - [ ] 汇率计算
  - [ ] 手续费处理（如有）

**前端工具：**
- [ ] 🎨 实现货币格式化工具 `idle-game-frontend/src/utils/format.ts`
  - [ ] formatGems() - 宝石格式化（千分位）
  - [ ] formatShells() - 贝壳格式化
  - [ ] formatCurrency() - 通用货币格式化
  - [ ] 小数位处理（保留2位）
- [ ] 🎨 创建货币转换器组件
  - [ ] 实时显示兑换预览
  - [ ] 汇率显示

**联调任务：**
- [ ] 🔄 联调货币兑换功能
- [ ] 🧪 测试汇率计算准确性

#### 4.3 防刷与限额

**后端任务：**
- [ ] 🔧 实现每日能量购买上限校验
  - [ ] 查询当日购买记录
  - [ ] 累计购买量校验
  - [ ] 日上限：200点能量
  - [ ] 使用Redis存储每日计数
- [ ] 🔧 实现设备绑定校验
  - [ ] 单设备登录账号数 ≤ 2
  - [ ] 使用Redis存储设备-账号映射
  - [ ] 超限返回错误提示
- [ ] 🔧 实现异常产出预警机制
  - [ ] 监控单用户产出速率
  - [ ] 超过阈值自动标记
  - [ ] 发送告警通知
  - [ ] 自动限流/封禁

**前端任务：**
- [ ] 🎨 添加限额提示UI
  - [ ] 购买上限提示
  - [ ] 剩余额度显示
  - [ ] 超限错误提示

**测试任务：**
- [ ] 🧪 测试日购买上限
- [ ] 🧪 测试设备绑定限制
- [ ] 🧪 模拟异常产出行为

### 5. 商店与兑换 ✅

> ✅ **完成时间**: 2025-10-11 17:35
> **完成内容**: 完整实现商店系统，包括商品配置、限购检查、兑换流程、星宠蛋孵化、前端商城UI和开蛋动画

#### 5.1 商店后端 ✅

**数据库任务：** ✅
- [x] 📊 设计商品配置表（ShopItem） ✅ 2025-10-11 17:10
  - [x] sku (商品SKU，唯一)
  - [x] name (商品名称)
  - [x] type (类型：PET_EGG/ENERGY/TICKET/MATERIAL)
  - [x] rarity (稀有度，针对星宠蛋)
  - [x] price (价格)
  - [x] currency (货币类型：GEM/SHELL)
  - [x] dailyLimit (每日限购数量)
  - [x] totalStock (总库存，-1表示无限)
  - [x] resetType (重置类型：DAILY/WEEKLY/NEVER)
  - [x] isActive (是否上架)
  - [x] sortOrder (排序)
- [x] 📊 设计用户购买记录表（ShopPurchase） ✅ 2025-10-11 17:10
  - [x] id (主键)
  - [x] userId (外键)
  - [x] sku (商品SKU)
  - [x] quantity (购买数量)
  - [x] totalPrice (总价)
  - [x] purchaseDate (购买日期，用于限购)
  - [x] timestamp (时间戳)
  - [x] 索引优化（userId + sku + purchaseDate）

**后端任务：** ✅
- [x] 🔧 实现商品列表接口 `GET /api/shop/list` ✅ 2025-10-11 17:18
  - [x] 查询所有上架商品
  - [x] 包含用户今日购买情况
  - [x] 包含剩余库存
  - [x] 计算剩余限购数量
  - [x] 按sortOrder排序
- [x] 🔧 实现商品兑换接口 `POST /api/shop/exchange` ✅ 2025-10-11 17:20
  - [x] 商品存在性校验
  - [x] 库存充足校验
  - [x] 限购次数校验（基于purchaseDate）
  - [x] 余额充足校验
  - [x] 扣除货币（事务，调用walletService）
  - [x] 扣减库存（事务）
  - [x] 记录购买记录
  - [x] 发放商品（根据类型分发）
- [ ] 🔧 实现库存重置定时任务 ⏳
  - [ ] 每日0点重置DAILY类型商品
  - [ ] 每周一0点重置WEEKLY类型
  - [ ] 使用node-cron定时执行
  - [ ] 重置购买记录计数
- [x] 🔧 实现蛋孵化逻辑 `shopService.openEgg()` ✅ 2025-10-11 17:15
  - [x] 根据蛋稀有度生成星宠
  - [x] 概率权重计算（支持出更高稀有度）
  - [x] 创建星宠记录
  - [x] 随机生成星宠名称
  - [x] 返回星宠信息

**后端服务层：** ✅
- [x] 🔧 创建商店服务 `idle-game-backend/src/services/shop.service.ts` ✅ 2025-10-11 17:15
  - [x] getItems() - 获取商品列表（含用户购买统计）
  - [x] canPurchaseItem() - 检查是否可购买
  - [x] exchange() - 执行兑换（完整事务）
  - [x] grantItem() - 发放商品
  - [x] openEgg() - 开蛋（支持批量）
  - [x] determinePetRarity() - 稀有度随机算法
  - [x] generatePetName() - 随机名称生成
  - [x] initializeShopItems() - 初始化商品数据

**联调任务：** ✅
- [x] 🔄 联调商品列表查询 ✅ 2025-10-11 17:28
- [x] 🧪 测试限购逻辑 ✅ 2025-10-11 17:28
- [ ] 🧪 测试并发兑换 ⏳ 待压测环境

#### 5.2 商店前端 ✅

**前端任务：** ✅
- [x] 🎨 重构商店页面 `idle-game-frontend/src/pages/shop/ShopPage.tsx` ✅ 2025-10-11 17:22
  - [x] 改为星宠商店主题
  - [x] 移除旧的购物车逻辑
  - [x] 添加tab切换（商城/购买记录）
  - [x] 简化为直接兑换模式
- [x] 🎨 创建商品卡片组件 `idle-game-frontend/src/pages/shop/components/ShopItems.tsx` ✅ 2025-10-11 17:25
  - [x] 商品图标（根据类型动态显示）
  - [x] 商品名称与描述
  - [x] 价格显示（货币图标💎🐚）
  - [x] 限购标识（今日已购X/Y）
  - [x] 剩余限购数量显示
  - [x] 库存售罄状态
  - [x] 兑换按钮（禁用状态处理）
  - [x] 稀有度颜色带
- [x] 🎨 实现兑换确认弹窗 `idle-game-frontend/src/pages/shop/components/ExchangeModal.tsx` ✅ 2025-10-11 17:30
  - [x] 商品预览（名称、描述、稀有度）
  - [x] 数量选择器（-/+按钮）
  - [x] 限购数量限制
  - [x] 总价动态计算
  - [x] 消耗货币展示（大图标）
  - [x] 确认/取消按钮
  - [x] 加载状态处理
- [x] 🎨 实现兑换成功动画 ✅ 2025-10-11 17:32
  - [x] 开蛋动画（🥚✨）
  - [x] 获得星宠展示（稀有度渐变背景）
  - [x] 星宠信息显示（名称、稀有度、等级）
  - [x] 动画效果（scale-in、pulse、bounce）
  - [x] 能量包动画（⚡）
  - [x] 自动关闭并刷新
- [x] 🎨 创建购买记录组件 `idle-game-frontend/src/pages/shop/components/PurchaseHistory.tsx` ✅ 2025-10-11 17:33
  - [x] 从交易记录筛选商店兑换
  - [x] 显示兑换时间
  - [x] 显示商品信息
  - [x] 显示消耗货币
  - [x] 空状态提示

**状态管理：** ⏳
- [ ] 🎨 优化商店状态 `idle-game-frontend/src/store/shopStore.ts` ⏳ 可选
  - 说明：当前直接使用API调用，无需复杂状态管理
  - 如需要可后续优化为状态缓存

**联调任务：** ✅
- [x] 🔄 联调商品展示 ✅ 2025-10-11 17:28
- [x] 🔄 联调兑换流程 ✅ 2025-10-11 17:30
- [x] 🧪 测试开蛋动画 ✅ 2025-10-11 17:32

### 6. 数据监控与管理后台

> 使用已有的 `game-backstage/` 项目

#### 6.1 核心指标看板

**后端任务：**
- [ ] 🔧 实现统计聚合服务 `idle-game-backend/src/services/analytics.service.ts`
  - [ ] 用户统计：注册数、DAU、留存率
  - [ ] 在线时长统计：平均时长、时长分布
  - [ ] 经济统计：宝石产出/消耗、贝壳产出/消耗
  - [ ] 游戏数据：挂机参与率、平均收益
- [ ] 🔧 实现统计数据接口 `GET /api/admin/stats`
  - [ ] 需要管理员权限认证
  - [ ] 支持时间范围查询
  - [ ] 支持数据导出
  - [ ] 数据缓存（Redis 5分钟）
- [ ] 🔧 实现实时监控接口 `GET /api/admin/monitor/realtime`
  - [ ] 当前在线用户数
  - [ ] 每分钟产出宝石
  - [ ] 每分钟消耗宝石
  - [ ] API调用量统计

**后台前端任务：**
- [ ] 🎨 设计后台管理页面路由 (`game-backstage/`)
  - [ ] /admin/dashboard - 总览
  - [ ] /admin/users - 用户管理
  - [ ] /admin/economy - 经济监控
  - [ ] /admin/logs - 日志查询
- [ ] 🎨 实现管理员权限控制
  - [ ] 登录验证
  - [ ] 角色权限管理
  - [ ] 操作审计
- [ ] 🎨 实现用户统计看板
  - [ ] 注册趋势图（折线图）
  - [ ] DAU/MAU数据卡片
  - [ ] 留存率漏斗图
  - [ ] 实时在线人数
- [ ] 🎨 实现在线时长分析
  - [ ] 平均在线时长
  - [ ] 时长分布直方图
  - [ ] Top用户排行
- [ ] 🎨 实现经济监控看板
  - [ ] 宝石产出/消耗对比图
  - [ ] 贝壳产出/消耗对比图
  - [ ] 经济健康度指标
  - [ ] 异常预警提示
- [ ] 🎨 集成数据可视化组件
  - [ ] 使用 ECharts/Recharts
  - [ ] 实时数据刷新
  - [ ] 图表交互功能

**联调任务：**
- [ ] 🔄 联调统计数据查询
- [ ] 🔄 测试实时监控数据
- [ ] 🧪 验证权限控制

#### 6.2 日志与追溯

**后端任务：**
- [ ] 🔧 搭建日志收集系统
  - [ ] Winston日志已配置（已完成）
  - [ ] 日志分级：ERROR/WARN/INFO/DEBUG
  - [ ] 日志轮转（每日/按大小）
  - [ ] 日志持久化存储
- [ ] 🔧 实现审计日志服务 `auditService.log()`
  - [ ] 记录用户登录
  - [ ] 记录商品兑换
  - [ ] 记录收益领取
  - [ ] 记录敏感操作
  - [ ] 包含用户ID、IP、时间戳、操作详情
- [ ] 🔧 实现日志查询接口 `GET /api/admin/logs`
  - [ ] 支持关键字搜索
  - [ ] 支持时间范围
  - [ ] 支持用户筛选
  - [ ] 支持日志级别筛选
  - [ ] 分页返回
- [ ] 🔧 添加异常告警机制
  - [ ] 监控单用户产出速率异常
  - [ ] 监控接口错误率（>1%告警）
  - [ ] 监控系统资源（CPU/内存）
  - [ ] 钉钉/企业微信告警推送
  - [ ] 告警规则配置

**后台前端任务：**
- [ ] 🎨 实现日志查询页面
  - [ ] 搜索框（关键字、用户ID）
  - [ ] 时间范围选择器
  - [ ] 日志级别筛选
  - [ ] 日志列表展示
  - [ ] 详情查看
- [ ] 🎨 实现告警管理页面
  - [ ] 告警历史列表
  - [ ] 告警规则配置
  - [ ] 告警状态（已处理/未处理）

**测试任务：**
- [ ] 🧪 测试日志记录完整性
- [ ] 🧪 测试告警触发机制

### 7. 测试与验收

#### 7.1 功能测试

**后端测试：**
- [ ] 🧪 编写认证流程测试 `idle-game-backend/src/__tests__/auth.test.ts`
  - [ ] 注册流程测试
  - [ ] 登录成功/失败测试
  - [ ] token验证测试
  - [ ] 实名认证流程测试
- [ ] 🧪 编写挂机收益计算测试 `afk.test.ts`
  - [ ] 边界值测试（0小时、最大时长）
  - [ ] 在线收益计算准确性
  - [ ] 离线收益计算准确性（80%系数）
  - [ ] 时间篡改防护测试
  - [ ] 12小时上限测试
- [ ] 🧪 编写能量系统测试 `energy.test.ts`
  - [ ] 能量耗尽停止挂机
  - [ ] 能量自然恢复测试
  - [ ] 能量购买上限测试（200/天）
  - [ ] 能量消耗正确性
- [ ] 🧪 编写商店兑换测试 `shop.test.ts`
  - [ ] 库存扣减正确性
  - [ ] 限购校验测试
  - [ ] 并发兑换一致性测试
  - [ ] 库存为0时拒绝兑换
- [ ] 🧪 编写并发收益领取测试
  - [ ] 幂等性测试（多次领取）
  - [ ] 并发领取一致性
  - [ ] 事务回滚测试

**前端测试：**
- [ ] 🧪 编写组件单元测试
  - [ ] Button组件测试
  - [ ] PetCard组件测试
  - [ ] EnergyBar组件测试
- [ ] 🧪 编写页面集成测试
  - [ ] 登录页面测试
  - [ ] 游戏主页测试
  - [ ] 商店页面测试

**E2E测试：**
- [ ] 🧪 编写端到端测试用例
  - [ ] 完整游戏流程测试
  - [ ] 用户旅程测试

#### 7.2 安全测试

**后端安全测试：**
- [ ] 🧪 验证时间伪造防护
  - [ ] 修改客户端时间测试
  - [ ] 服务器时间权威性验证
  - [ ] 时间戳签名验证
- [ ] 🧪 验证重放攻击防护
  - [ ] nonce机制测试
  - [ ] 请求签名验证
  - [ ] 重复请求拦截
- [ ] 🧪 验证并发交易一致性
  - [ ] 同时提交多个交易
  - [ ] 验证余额正确性
  - [ ] 验证流水记录完整
- [ ] 🧪 验证设备绑定限制
  - [ ] 单设备登录2账号测试
  - [ ] 第3个账号被拒绝
  - [ ] 设备ID校验

**安全扫描：**
- [ ] 🧪 SQL注入扫描（Prisma已防护）
- [ ] 🧪 XSS攻击扫描
- [ ] 🧪 CSRF攻击防护验证
- [ ] 🧪 敏感信息泄露检查

#### 7.3 性能测试

**后端性能测试：**
- [ ] 🧪 压力测试（使用 JMeter/k6）
  - [ ] 目标：3k QPS
  - [ ] P95延迟 < 120ms
  - [ ] P99延迟 < 200ms
  - [ ] 错误率 < 0.1%
- [ ] 🧪 接口响应时间测试
  - [ ] 登录接口 < 100ms
  - [ ] 查询接口 < 50ms
  - [ ] 交易接口 < 200ms
- [ ] 🧪 数据库查询优化
  - [ ] 慢查询分析
  - [ ] 索引效果验证
  - [ ] 查询计划优化
- [ ] 🧪 缓存效果测试
  - [ ] Redis命中率 > 80%
  - [ ] 缓存失效测试

**前端性能测试：**
- [ ] 🧪 页面加载性能
  - [ ] FCP < 1.5s
  - [ ] LCP < 2.5s
  - [ ] TTI < 3.5s
- [ ] 🧪 资源优化验证
  - [ ] 代码分割效果
  - [ ] 图片懒加载
  - [ ] Bundle大小 < 500KB

**稳定性测试：**
- [ ] 🧪 长时间运行测试（7×24小时）
- [ ] 🧪 内存泄漏检测
- [ ] 🧪 异常恢复测试

---

## 🚀 第二阶段：内容扩展与社交 (6-8周)

> **说明**：第二、第三阶段的待办事项同样遵循前后端分工原则。  
> 详细的前后端任务分工请参考 [TODO_SUMMARY.md](./TODO_SUMMARY.md)

### 前后端分工总览

| 系统 | 后端核心 | 前端核心 |
|------|---------|---------|
| **融合系统** | 🔧 融合引擎+概率计算+记录 | 🎨 融合页面+材料选择+动画 |
| **等级系统** | 🔧 经验表+升级接口+加成计算 | 🎨 等级UI+经验条+升级动画 |
| **矿点挑战** | 🔧 挑战接口+计时结算+奖励 | 🎨 矿点页面+倒计时+领奖 |
| **社交系统** | 🔧 好友关系+助力+邀请接口 | 🎨 好友列表+助力+分享海报 |
| **任务成就** | 🔧 任务引擎+进度追踪+奖励 | 🎨 任务页面+进度条+红点 |

### 8. 星宠融合系统 ✅

> ✅ **完成时间**: 2025-10-11 19:05
> **完成内容**: 完整的融合系统，包括规则引擎、材料验证、概率计算、融合执行、前端UI和动画

#### 8.1 融合规则引擎 ✅

- [x] 设计融合配置表（FusionAttempt + FusionMaterial） ✅ 2025-10-11 18:25
  - [x] FusionAttempt: userId, targetRarity, shellCost, useProtection, success, resultPetId
  - [x] FusionMaterial: fusionAttemptId, petId, petRarity, petLevel (中间表)
- [x] 实现融合规则配置 ✅ 2025-10-11 18:30
  - [x] 普通→稀有：3普通，200贝壳，70%成功率
  - [x] 稀有→史诗：3稀有，500贝壳，50%成功率
  - [x] 史诗→传说：3史诗，1000贝壳，30%成功率
  - [x] 传说→神话：3传说，2000贝壳，20%成功率
- [x] 实现融合尝试接口 `POST /api/fusion/attempt` ✅ 2025-10-11 18:35
  - [x] 材料验证（数量、稀有度）
  - [x] 余额检查（贝壳）
  - [x] 概率计算（支持保护符100%）
  - [x] Prisma事务保证一致性
- [x] 实现概率计算与随机结果生成 ✅ 2025-10-11 18:30
  - [x] Math.random() < successRate
  - [x] 保护符机制（预留）
- [x] 实现融合成功逻辑 ✅ 2025-10-11 18:35
  - [x] 消耗材料（删除星宠）
  - [x] 扣除贝壳手续费
  - [x] 生成新星宠（随机名称）
  - [x] 记录融合尝试
- [x] 实现融合失败逻辑 ✅ 2025-10-11 18:35
  - [x] 材料被消耗（删除）
  - [x] 贝壳不返还（全额消耗）
  - [x] 记录失败尝试
- [x] 实现材料验证接口 `POST /api/fusion/validate` ✅ 2025-10-11 18:40
- [x] 实现融合历史接口 `GET /api/fusion/history` ✅ 2025-10-11 18:40
- [x] 实现融合规则查询 `GET /api/fusion/rules` ✅ 2025-10-11 18:40

#### 8.2 融合UI ✅

- [x] 实现融合页面 `src/pages/fusion/FusionPage.tsx` ✅ 2025-10-11 18:50
  - [x] 融合规则卡片展示
  - [x] 目标稀有度选择
  - [x] 提示信息展示
- [x] 实现融合规则卡片 `FusionRuleCard.tsx` ✅ 2025-10-11 18:52
  - [x] 目标稀有度展示（图标、名称、渐变）
  - [x] 材料需求列表
  - [x] 手续费显示
  - [x] 成功率展示
  - [x] 开始融合按钮
- [x] 实现材料选择器 `MaterialSelector.tsx` ✅ 2025-10-11 18:55
  - [x] 支持多选3只同稀有度星宠
  - [x] 材料需求说明
  - [x] 已选择进度提示
  - [x] 网格布局展示可选星宠
  - [x] 选中状态高亮
  - [x] 手续费确认
- [x] 实现融合结果弹窗 `FusionResultModal.tsx` ✅ 2025-10-11 19:00
  - [x] 成功动画（bounce、pulse、scale-in）
  - [x] 失败动画（灰色主题）
  - [x] 新星宠信息展示
  - [x] 自动关闭（4秒）
- [ ] 添加融合保护符使用选项 ⏳ 预留第三阶段
- [ ] 实现融合历史记录页面 ⏳ 可选功能

#### 8.3 融合测试 ⏳

- [ ] 编写概率统计测试（1000次融合验证偏差<±2%） ⏳ 待测试环境
- [ ] 编写边界测试（材料不足、贝壳不足、异常中断） ⏳ 待测试环境

### 9. 星宠等级系统 ✅ **已完成** (2025-10-11)

#### 9.1 升级逻辑 ✅
- [x] 设计经验值表（ExpTable：level, requiredExp, accumulatedExp）
- [x] 实现经验获取途径（挂机时长、完成任务等）
- [x] 实现升级接口和服务 `level.service.ts`, `level.routes.ts`
- [x] 实现等级加成计算（每级+5%产出）
- [x] 设计等级上限（30级）

**实现文件**：
- 后端：`level.service.ts`, `level.routes.ts`, `afk.service.ts`（集成经验获取）
- API：`GET /api/level/exp-table`, `GET /api/level/pet/:petId`, `GET /api/level/user-stats`, `POST /api/level/add-exp`

#### 9.2 升级UI ✅
- [x] 在星宠卡片添加等级与经验条
- [x] 实现升级动画与通知（LevelUpModal组件）
- [x] 实现等级加成数值展示

**实现文件**：
- 前端：`PetCard.tsx`（经验条）, `LevelUpModal.tsx`（升级弹窗）, `GamePage.tsx`（集成）
- API集成：`api.ts`

### 10. 矿点挑战系统 ✅ **已完成** (2025-10-11)

#### 10.1 矿点后端 ✅
- [x] 设计矿点配置表（MineChallenge表）
- [x] 实现矿点列表接口 `GET /api/mine/list`
- [x] 实现挑战入场接口 `POST /api/mine/enter`（含矿票消耗、能量校验）
- [x] 实现挑战计时与自动结算逻辑
- [x] 实现奖励领取接口 `POST /api/mine/claim`
- [x] 实现挑战状态查询 `GET /api/mine/status`
- [x] 实现挑战历史查询 `GET /api/mine/history`

**实现文件**：
- 后端：`mine.service.ts`, `mine.routes.ts`, `cron.ts`（自动结算）
- 数据库：Wallet表添加`mineTicket`字段
- API：5个接口

**矿点配置**：
- Lv1 初级矿洞：1票+10能量，5分钟，50💎+100🐚
- Lv2 中级矿洞：1票+20能量，10分钟，120💎+250🐚
- Lv3 高级矿洞：2票+30能量，15分钟，220💎+500🐚
- Lv4 精英矿洞：2票+40能量，20分钟，350💎+800🐚
- Lv5 传说矿洞：3票+50能量，30分钟，550💎+1300🐚

#### 10.2 矿点UI ✅
- [x] 实现矿点页面 `src/pages/mine/MinePage.tsx`
- [x] 实现矿点卡片组件（MineSpotCard）
- [x] 实现挑战进度弹窗（ChallengeProgressModal）
- [x] 实现奖励领取弹窗（RewardModal）
- [x] 添加实时倒计时和进度条
- [x] 添加资源状态显示（矿票、能量）

**实现文件**：
- 前端：`MinePage.tsx`, `MineSpotCard.tsx`, `ChallengeProgressModal.tsx`, `RewardModal.tsx`
- 路由：添加`/mine`路由
- 导航：添加"矿点"入口

#### 10.3 矿票系统 ✅
- [x] 在Wallet表中添加矿票字段（默认3张）
- [x] 实现矿票消耗记录（EnergyLedger）
- [ ] 实现矿票获取途径（任务奖励、商店购买）⏳ 待完善

### 11. 社交系统

#### 11.1 好友与助力
- [ ] 设计好友关系表（Friendship：userId, friendId, status, timestamp）
- [ ] 实现好友列表接口 `GET /api/social/friends`
- [ ] 实现好友搜索/添加接口 `POST /api/social/add`
- [ ] 实现助力接口 `POST /api/social/assist`（含次数限制、互惠奖励）
- [ ] 实现每日助力次数重置定时任务
- [ ] 设计助力记录表（AssistLog：userId, friendId, energyGained, timestamp）

#### 11.2 邀请系统
- [ ] 设计邀请码生成逻辑（唯一性、可追溯）
- [ ] 实现邀请绑定接口 `POST /api/invite/bind`
- [ ] 实现邀请奖励发放逻辑（稀有星宠蛋）
- [ ] 实现邀请收益分成机制（平台补贴）
- [ ] 设计邀请记录表（InviteRecord：inviterId, inviteeId, code, rewards, timestamp）

#### 11.3 社交UI
- [ ] 改造 `src/pages/invite/InviteRecordsPage.tsx` 展示邀请记录
- [ ] 实现好友列表页面 `src/pages/social/FriendsPage.tsx`
- [ ] 实现助力按钮与状态展示（已助力/冷却中）
- [ ] 优化 `src/pages/profile/components/InviteSection.tsx` 展示邀请码与分享
- [ ] 实现分享海报生成功能（复用 `src/pages/poster/PosterPage.tsx`）

### 12. 任务与成就系统

#### 12.1 任务系统 ✅ **已完成** (2025-10-11)
- [x] 设计任务配置表（Task：taskId, type, condition, rewards, resetType）
- [x] 实现任务列表接口 `GET /api/task/list`
- [x] 实现任务进度更新逻辑（事件驱动）
- [x] 实现任务完成接口 `POST /api/task/claim`
- [x] 实现每日任务重置定时任务
- [x] 设计新手任务引导流程

**实现文件**：
- 后端：`task.service.ts`, `task.routes.ts`, `cron.ts`
- 前端：`TasksPage.tsx`, `TaskCard.tsx`, `RewardModal.tsx`
- API：`GET /task/list`, `POST /task/claim`, `POST /task/init`

#### 12.2 成就系统
- [ ] 设计成就配置表（Achievement：achievementId, condition, rewards, tier）
- [ ] 实现成就列表接口 `GET /api/achievement/list`
- [ ] 实现成就解锁逻辑
- [ ] 实现成就奖励领取接口 `POST /api/achievement/claim`

#### 12.3 任务成就UI ✅ **任务UI已完成** (2025-10-11)
- [x] 实现任务页面 `src/pages/tasks/TasksPage.tsx`
- [x] 实现任务卡片组件（进度条、奖励、状态）
- [ ] 改造 `src/pages/game/components/AchievementList.tsx` 展示成就
- [x] 实现任务完成通知（奖励弹窗）

### 13. 第二阶段测试

#### 13.1 功能测试
- [ ] 融合系统概率与状态测试
- [ ] 矿点挑战流程测试（中断、重连、结算）
- [ ] 社交助力与邀请流程测试
- [ ] 任务进度追踪与重置测试

#### 13.2 风控测试
- [ ] 同设备/IP批量助力拦截测试
- [ ] 批量邀请风控测试
- [ ] 异常融合行为检测测试

---

## 💎 第三阶段：深度优化与商业化 (8-10周)

> **说明**：第三阶段专注于商业化功能和系统优化。  
> 详细任务分工请参考 [TODO_SUMMARY.md](./TODO_SUMMARY.md)

### 前后端分工总览

| 系统 | 后端核心 | 前端核心 |
|------|---------|---------|
| **技能羁绊** | 🔧 技能配置+升级+羁绊检测 | 🎨 技能树页面+羁绊图鉴 |
| **付费功能** | 🔧 支付接口+回调+订单 | 🎨 商品页+支付流程 |
| **提现系统** | 🔧 提现流程+审核+到账 | 🎨 提现页面+记录查询 |
| **动态调控** | 🔧 衰减计算+配置中心 | 🎨 实时显示+公告 |
| **高级风控** | 🔧 AI检测+规则引擎 | - |
| **活动系统** | 🔧 活动配置+定时任务 | 🎨 活动页面+倒计时 |
| **性能优化** | 🔧 缓存+读写分离+负载均衡 | 🎨 代码分割+CDN+懒加载 |

### 14. 神话星宠与技能系统

#### 14.1 神话星宠
- [ ] 设计神话核心道具获取途径
- [ ] 实现神话星宠融合逻辑（5%成功率）
- [ ] 设计神话星宠专属外观与特效
- [ ] 实现神话星宠稀有度展示

#### 14.2 技能系统
- [ ] 设计技能配置表（Skill：skillId, petRarity, effect, levelMax）
- [ ] 实现技能库查询接口 `GET /api/skill/list`
- [ ] 实现技能升级接口 `POST /api/skill/upgrade`（消耗技能石）
- [ ] 实现技能效果计算（产出加成/特殊能力）
- [ ] 设计技能石获取途径（高级矿点、活动奖励）

#### 14.3 技能UI
- [ ] 实现技能页面 `src/pages/skill/SkillPage.tsx`
- [ ] 实现技能树可视化展示
- [ ] 实现技能升级确认弹窗
- [ ] 在星宠详情页展示已解锁技能

### 15. 羁绊系统

#### 15.1 羁绊规则
- [ ] 设计羁绊配置表（Bond：bondId, petTags, threshold, bonus）
- [ ] 实现羁绊激活检测逻辑
- [ ] 实现羁绊加成应用到产出计算
- [ ] 设计星宠系列标签（如：火系、水系、星空系等）

#### 15.2 羁绊UI
- [ ] 实现羁绊图鉴页面 `src/pages/bond/BondPage.tsx`
- [ ] 展示已激活/未激活羁绊
- [ ] 展示羁绊收集进度与加成数值

### 16. 商业化功能

#### 16.1 付费道具
- [ ] 设计加速卡（缩短矿点时间/加快经验获取）
- [ ] 设计融合保护符（失败不损失材料）
- [ ] 设计祝福石（提升融合成功率）
- [ ] 实现付费道具购买接口 `POST /api/shop/buy`
- [ ] 对接支付渠道（微信/支付宝）
- [ ] 实现支付回调与到账校验

#### 16.2 月卡/特权卡
- [ ] 设计月卡特权内容（每日宝石、产出加成、特殊权益）
- [ ] 实现订阅服务购买接口
- [ ] 实现月卡自动续费逻辑
- [ ] 实现月卡到期提醒与权益回收
- [ ] 实现月卡每日奖励自动发放

#### 16.3 外观系统（可选）
- [ ] 设计星宠皮肤素材
- [ ] 设计挂机场景皮肤
- [ ] 实现皮肤购买与装备逻辑
- [ ] 实现皮肤展示UI

#### 16.4 提现系统
- [ ] 实现提现申请接口 `POST /api/withdraw/apply`（10宝石起、10%手续费）
- [ ] 实现提现审核流程（人工/自动）
- [ ] 对接提现渠道（银行卡/支付宝）
- [ ] 实现T+1到账逻辑
- [ ] 设计提现记录表（WithdrawLog：userId, amount, fee, status, timestamp）

### 17. 高级数值调控

#### 17.1 动态难度系统
- [ ] 实现"宇宙能量潮汐"机制（全局产出波动）
- [ ] 设计潮汐周期与系数配置
- [ ] 实现潮汐预告与实时提示

#### 17.2 平台产出上限
- [ ] 实现每日全平台宝石产出监控
- [ ] 实现动态衰减系数计算（公式：`D = max(0.2, 1 - α × (P-Q)/Q)`）
- [ ] 实现衰减系数实时应用到产出计算
- [ ] 添加衰减预警与运营通知

#### 17.3 参数热更新
- [ ] 搭建配置中心（Apollo/Nacos）
- [ ] 实现关键参数热更新（离线系数、能量消耗、衰减强度等）
- [ ] 实现配置灰度发布功能
- [ ] 实现配置回滚机制

### 18. 高级风控系统

#### 18.1 AI行为分析
- [ ] 收集用户行为数据（点击节律、操作序列、时长分布）
- [ ] 训练异常行为检测模型（脚本特征识别）
- [ ] 实现实时行为评分系统
- [ ] 实现异常账号自动标记与降权

#### 18.2 经济风控
- [ ] 实现大额交易实时预警
- [ ] 实现异常产出自动限流
- [ ] 实现提现排队与额度管控
- [ ] 设计人工审核队列与工作台

#### 18.3 风控策略配置
- [ ] 实现风控规则配置界面
- [ ] 实现风控策略灰度发布
- [ ] 监控误杀率与准确率

### 19. 活动系统

#### 19.1 活动配置
- [ ] 设计活动配置表（Event：eventId, type, startTime, endTime, bonus）
- [ ] 实现活动列表接口 `GET /api/event/list`
- [ ] 实现活动自动开启/关闭定时任务

#### 19.2 限时活动
- [ ] 实现收益翻倍活动（临时调整 b_A 参数）
- [ ] 实现限时商店（特殊商品上架）
- [ ] 实现节假日特殊奖励

#### 19.3 活动UI
- [ ] 实现活动页面 `src/pages/event/EventPage.tsx`
- [ ] 实现活动倒计时与进度展示
- [ ] 添加活动入口引导与红点提示

### 20. 性能优化

#### 20.1 前端优化
- [ ] 代码分割与懒加载（React.lazy + Suspense）
- [ ] 图片资源压缩与CDN加速
- [ ] 实现虚拟列表（长列表性能优化）
- [ ] 优化渲染性能（React.memo、useMemo、useCallback）
- [ ] 实现离线缓存（Service Worker）

#### 20.2 后端优化
- [ ] 数据库查询优化与索引调整
- [ ] 实现Redis缓存热点数据（用户信息、星宠列表等）
- [ ] 实现接口限流与熔断（Sentinel/Hystrix）
- [ ] 实现数据库读写分离
- [ ] 实现消息队列异步处理（RabbitMQ/Kafka）

#### 20.3 服务器扩容
- [ ] 实施负载均衡（Nginx/LVS）
- [ ] 实现水平扩展方案
- [ ] 部署监控系统（Prometheus + Grafana）
- [ ] 实现自动伸缩（K8s HPA）

### 21. 数据分析与运营

#### 21.1 高级数据看板
- [ ] 实现用户画像分析（付费/零撸/流失分层）
- [ ] 实现漏斗分析（注册→实名→首充→留存）
- [ ] 实现收益分析（ARPU、ARPPU、LTV）
- [ ] 实现经济健康度监控（产消比、通胀率）

#### 21.2 A/B测试框架
- [ ] 搭建A/B测试平台
- [ ] 实现流量分组与实验追踪
- [ ] 实现实验效果分析与报告

### 22. 第三阶段测试

#### 22.1 压力测试
- [ ] 峰值QPS压测（目标：3k QPS，P95<120ms）
- [ ] 长时间稳定性测试（7×24小时）
- [ ] 支付流程压测与容错测试

#### 22.2 回归测试
- [ ] 全功能回归测试套件
- [ ] 经济系统参数变更影响测试
- [ ] 跨日/跨月结转数据一致性测试

#### 22.3 安全审计
- [ ] 渗透测试（SQL注入、XSS、CSRF等）
- [ ] 支付安全审计
- [ ] 隐私合规审计（GDPR/个人信息保护法）

---

## 📦 部署与发布

### 23. 部署准备

#### 23.1 环境搭建
- [ ] 搭建开发环境（Dev）
- [ ] 搭建测试环境（Test）
- [ ] 搭建预发布环境（Staging）
- [ ] 搭建生产环境（Production）

#### 23.2 CI/CD
- [ ] 配置代码仓库与分支策略（Git Flow）
- [ ] 搭建CI/CD流水线（Jenkins/GitLab CI）
- [ ] 实现自动化测试集成
- [ ] 实现自动化部署与回滚

#### 23.3 监控告警
- [ ] 部署APM监控（Skywalking/Pinpoint）
- [ ] 配置错误告警（钉钉/企业微信）
- [ ] 配置性能告警（响应时间、错误率）
- [ ] 配置业务告警（产出异常、用户流失）

### 24. 灰度发布

#### 24.1 MVP灰度
- [ ] 选择5%种子用户进行灰度
- [ ] 监控关键指标（注册转化、挂机参与、收益发放）
- [ ] 收集用户反馈并快速迭代

#### 24.2 第二阶段灰度
- [ ] 扩大灰度范围至20%用户
- [ ] 验证融合系统概率与社交裂变效果
- [ ] 监控服务器负载与性能

#### 24.3 全量发布
- [ ] 制定全量发布计划与应急预案
- [ ] 执行全量发布
- [ ] 实时监控并准备回滚

### 25. 运营准备

#### 25.1 内容准备
- [ ] 编写用户使用手册
- [ ] 制作新手引导视频
- [ ] 准备客服FAQ文档

#### 25.2 市场推广
- [ ] 制定推广策略与预算
- [ ] 设计宣传素材（海报、视频）
- [ ] 对接推广渠道（广告投放、KOL合作）

#### 25.3 客服体系
- [ ] 搭建客服系统（工单/在线客服）
- [ ] 培训客服团队
- [ ] 制定常见问题处理流程

---

## 📊 项目管理

### 里程碑时间线

| 阶段 | 时长 | 关键交付物 | 验收标准 |
|------|------|-----------|---------|
| **第一阶段** | 8-10周 | MVP核心闭环 | 注册→挂机→领取→兑换流程跑通 |
| **第二阶段** | 6-8周 | 内容扩展与社交 | 融合、矿点、社交系统上线 |
| **第三阶段** | 8-10周 | 深度优化与商业化 | 付费功能、风控系统完善 |

### 团队配置建议

- **前端工程师**：2人（React + TypeScript）
- **后端工程师**：3人（主架构 + 业务逻辑 + 运维）
- **UI设计师**：1人
- **产品经理**：1人
- **测试工程师**：1人
- **数据分析师**：1人（第二阶段引入）

### 风险管理

| 风险类型 | 可能影响 | 缓解措施 |
|---------|---------|---------|
| 数值通胀 | 经济崩溃 | 动态衰减+上限控制 |
| 脚本刷量 | 收益损失 | 多维度风控+AI检测 |
| 提现挤兑 | 资金压力 | 限额+排队+手续费调节 |
| 合规风险 | 业务叫停 | 实名认证+法务审查 |
| 技术债务 | 迭代变慢 | 代码审查+重构计划 |

---

## ✅ 验收清单

### MVP验收（第一阶段）
- [ ] 注册/登录/实名认证流程完整无阻塞
- [ ] 单只星宠可稳定产生在线/离线收益
- [ ] 能量消耗/恢复/购买逻辑正确
- [ ] 商店兑换功能正常（库存、限购生效）
- [ ] 数据看板展示核心指标
- [ ] 所有接口P95延迟<120ms
- [ ] 并发测试通过，无幂等性问题

### 第二阶段验收
- [ ] 融合系统概率准确（误差<±2%）
- [ ] 矿点挑战流程完整（入场、计时、结算）
- [ ] 社交助力与邀请功能正常
- [ ] 任务系统可配置化发布
- [ ] 风控策略有效拦截异常行为

### 第三阶段验收
- [ ] 付费流程完整（下单-支付-到账-风控）
- [ ] 提现功能正常（审核-到账-手续费）
- [ ] 动态调控系统可热更新
- [ ] AI风控系统上线并正常运行
- [ ] 峰值QPS达标（3k QPS，P95<120ms）
- [ ] 7×24小时稳定性测试通过


**文档版本**：V1.0  
**创建日期**：2025-10-10  
**最后更新**：2025-10-10  
**维护人员**：开发团队

